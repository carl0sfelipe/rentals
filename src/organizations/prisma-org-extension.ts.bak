import { PrismaClient } from '@prisma/client';
import { OrganizationContextService } from './organization-context.service';

/**
 * Cria uma extensÃ£o Prisma que automaticamente injeta organizationId
 * para modelos tenant-scoped
 */
export function createPrismaOrgExtension(contextService: OrganizationContextService) {
  return (prisma: PrismaClient) => {
    return prisma.$extends({
      query: {
        // Property: tenant-scoped
        property: {
          create({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              data: {
                ...args.data,
                organizationId: activeOrgId,
              },
            });
          },

          findMany({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              where: {
                ...args.where,
                organizationId: activeOrgId,
              },
            });
          },

          findFirst({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              where: {
                ...args.where,
                organizationId: activeOrgId,
              },
            });
          },

          findUnique({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              where: {
                ...args.where,
                organizationId: activeOrgId,
              },
            });
          },

          count({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              where: {
                ...args.where,
                organizationId: activeOrgId,
              },
            });
          },

          update({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              where: {
                ...args.where,
                organizationId: activeOrgId,
              },
            });
          },

          delete({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              where: {
                ...args.where,
                organizationId: activeOrgId,
              },
            });
          },
        },

        // Booking: tenant-scoped
        booking: {
          create({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              data: {
                ...args.data,
                organizationId: activeOrgId,
              },
            });
          },

          findMany({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              where: {
                ...args.where,
                organizationId: activeOrgId,
              },
            });
          },

          findFirst({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              where: {
                ...args.where,
                organizationId: activeOrgId,
              },
            });
          },

          findUnique({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              where: {
                ...args.where,
                organizationId: activeOrgId,
              },
            });
          },

          count({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              where: {
                ...args.where,
                organizationId: activeOrgId,
              },
            });
          },

          update({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              where: {
                ...args.where,
                organizationId: activeOrgId,
              },
            });
          },

          delete({ args, query }) {
            const activeOrgId = contextService.getActiveOrganizationId();
            if (!activeOrgId) return query(args);

            return query({
              ...args,
              where: {
                ...args.where,
                organizationId: activeOrgId,
              },
            });
          },
        },
      },
    });
  };
}
